<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>YAIE.js</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<style>
			*{
				overflow: hidden;
				padding: 0;
				margin: 0;
			}
			body{
				height: 100vh;
				width: 100vw;
			}
			#preview{
				max-height: 100vh;
				max-width: 100vw;
				position: relative;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
			#sel{
				position: relative;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
			#img_input, #info{
				position: relative;
				left: 50%;
				transform: translateX(-50%);
				text-align: center;
			}
		</style>
	</head>
	<body>
		<div id="sel">
			<input id="img_input" type="file" accept="image/*" />
			<input id="password" type="text" />
			<button id="go" onclick="btn_click()">GO</button>
			<div id="info">Select a picture here and wait. When the result is displayed, you can save it by touch&hold or right click, or select another picture by touch or click on it.</div>
		</div>
		<img id="preview"></img>
		<script>
			'use strict';
			let main_canvas = document.createElement('canvas');
			let main_canvas_context = main_canvas.getContext("2d");
			let preview = document.getElementById("preview");
			let selector = document.getElementById("img_input");
			let sel = document.getElementById("sel");
			let pass = document.getElementById("password");
			preview.addEventListener("click", function(){
				this.style.display = "none";
				sel.style.display = "inline";
			}, false);
			class SeededRandom{
				constructor(seed){
					this.M = 714025;
					this.A = 4096;
					this.C = 150889;
					this.seed_ = seed % this.M;
				}
				setSeed(seed){
					this.seed_ = seed % this.M;
				}
				get(){
					this.seed_ = (this.A * this.seed_ + this.C) % this.M;
					return this.seed_;
				}
			}
			class Size{
				constructor(height, width){
					this.height_ = height;
					this.width_ = width;
				}
			}
			class ImagePart{
				constructor(data, x, y){
					this.data_ = data;
					this.x_ = x;
					this.y_ = y;
				}
			}
			function getNaturalSize(file, callback){
				getNaturalSize.Size = getNaturalSize.Size || new Size(0, 0);
				if(getNaturalSize.img == undefined){
					getNaturalSize.img = new Image();
					getNaturalSize.img.onload = function(){
						getNaturalSize.Size.height_ = getNaturalSize.img.naturalHeight;
						getNaturalSize.Size.width_ = getNaturalSize.img.naturalWidth;
						callback(getNaturalSize.img, getNaturalSize.Size);
					}
				}
				if(getNaturalSize.reader == undefined){
					getNaturalSize.reader = new FileReader();
					getNaturalSize.reader.onload = function(e){
						getNaturalSize.img.src = e.target.result;
					}
				}
				getNaturalSize.reader.readAsDataURL(file);
			}
			function main(image, natural_size){
				let rd = new SeededRandom(parseInt(pass.value));
				main_canvas.height = natural_size.height_;
				main_canvas.width = natural_size.width_;
				main_canvas_context.drawImage(image, 0, 0);
				let img_data = main_canvas_context.getImageData(0, 0, natural_size.width_, natural_size.height_);
				for(let i = 0; i < img_data.data.length; ++i) img_data.data[i] ^= (rd.get() % 256);
				main_canvas_context.putImageData(img_data, 0, 0);
				preview.src = main_canvas.toDataURL();
			}
			function btn_click(e){
				let tFile = selector.files[0];
				if(tFile.type.indexOf("image/") == -1) return;
				sel.style.display = "none";
				getNaturalSize(tFile, main);
			}
		</script>
	</body>
</html>